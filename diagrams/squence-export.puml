@startuml
actor –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
participant "Telegram Bot" as bot
participant "API Gateway\n(FastAPI)" as api
participant "Export Engine" as exporter
participant "User DB\n(PostgreSQL)" as db
participant "OAuth2 Service" as oauth
participant "Notion API" as notion
participant "Google Docs API" as gdocs
participant "Cache (Redis)" as cache
participant "Processed Article\nMetadata" as article

title –≠–∫—Å–ø–æ—Ä—Ç: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Notion –∏–ª–∏ Google Docs

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -> bot: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /export_notion\n–∏–ª–∏ /export_docs
bot -> api: POST /export\n{user_id, service, article_id}
api -> db: –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
db --> api: export_token, workspace_id (–µ—Å–ª–∏ –µ—Å—Ç—å)

alt –¢–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å
    api -> exporter: –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
else –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    api -> oauth: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å OAuth2\n(Notion –∏–ª–∏ Google)
    oauth --> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -> oauth: –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø
    oauth --> api: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç access_token
    api -> db: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ workspace
    api -> exporter: –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç
end

exporter -> article: –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
article --> exporter: title, summary, tags, claims, outline

exporter -> exporter: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ rich text\n(–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —Å–ø–∏—Å–∫–æ–≤)

alt –≠–∫—Å–ø–æ—Ä—Ç –≤ Notion
    exporter -> notion: createPage(parent=workspace)\n—Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
    notion --> exporter: page_id, url
else –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Docs
    exporter -> gdocs: createDocument(title)\n+ batchUpdate(content)
    gdocs --> exporter: document_id, url
end

exporter -> db: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç\n–∏ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞
exporter --> api: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç success + URL
api --> bot: –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
bot -> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!\nüîó [–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç]"

note right of oauth
  OAuth2 flow:
  - Notion: https://api.notion.com
  - Google: https://www.googleapis.com/auth/documents
  –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ –≤ –ë–î.
end note

note right of exporter
  Export Engine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π\n–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ExporterInterface.
  –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown ‚Üí rich text.
end note

note right of notion
  –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º\n—Ä–∞–±–æ—á–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ.
  –¢–µ–≥–∏ ‚Üí Notion properties (multi-select).
end note

note right of gdocs
  –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
  - –ó–∞–≥–æ–ª–æ–≤–∫–∏
  - –ú–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏
  - –¶–≤–µ—Ç–Ω—ã–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
end note

@enduml